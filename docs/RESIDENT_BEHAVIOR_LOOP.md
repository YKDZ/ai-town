# AI 小镇居民行为循环说明

## 概述

在 AI 小镇的模拟系统中，每个居民都按照一个持续的行为循环运作。这个循环由大语言模型（LLM）驱动，使得每个居民能够根据其个性、记忆、时间和环境做出独立的决策。

## 主循环结构

模拟系统的主循环位于 `src/core/simulation.py` 中的 `update()` 方法，每次循环执行以下步骤：

### 1. 时间推进
- 每个循环周期推进游戏时间（默认配置）
- 维护昼夜交替机制
- 跟踪当前日期、星期和具体时间

### 2. 交互处理
系统自动检测并触发居民间的交互：
- **位置检测**：将所有居民按当前位置分组
- **交互条件**：
  - 同一位置至少有2名居民
  - 双方都不在睡觉或忙碌状态
  - 未处于交互冷却时间内
  - 随机概率触发（避免持续对话）
- **对话生成**：通过 LLM 为双方生成符合人格的对话内容
- **记忆更新**：将对话内容添加到双方的记忆中
- **冷却设置**：设置交互冷却时间，防止频繁重复对话

### 3. 居民行为更新
对每个居民执行独立的行为更新循环：

## 单个居民的行为循环

每个居民的行为循环包含以下阶段：

### 阶段 1：状态检查

系统首先检查居民的当前状态：

1. **忙碌检查**：如果居民正在执行某个行为（`busy_until` 未到期），跳过本次更新
2. **思考检查**：如果居民正在思考（LLM 正在生成决策），跳过本次更新

### 阶段 2：规划决策（Planning）

当居民空闲时，系统异步启动规划线程，通过 LLM 生成下一步行动：

#### 输入信息
居民决策时会考虑以下信息：

1. **个人档案**：
   - 姓名、年龄、职业
   - 个性、特征、名言
   - 人际关系

2. **当前状态**：
   - 当前日期和时间
   - 当前所在位置
   - 个人记忆（包括过去的经历和目标）

3. **环境信息**：
   - 所有可访问的地点及其描述
   - 其他居民的当前位置和状态
   - 公告板信息（如果在小镇广场）

#### LLM 决策过程

系统使用结构化提示词（见 `src/ai/prompts.py`）引导 LLM 生成决策：

**系统提示词**包含：
- 居民完整的人物设定
- 全局行为规则（时间感知、地点限制等）
- 可用地点列表
- 其他居民位置信息

**用户提示词**包含：
- 当前日期、时间、位置
- 个人记忆和目标

**输出格式**（JSON）：
```json
{
  "action": "行为描述（英文）",
  "target_location": "目标地点",
  "dialogue": "想说的话（中文）",
  "emoji": "代表性表情符号",
  "duration": 持续时间（分钟）
}
```

#### 决策规则

居民在做决策时会遵循以下规则：

1. **时间感知**：深夜时（22:00后）会考虑回家睡觉
2. **位置选择**：只能前往已连接的地点
3. **社交意识**：可以查看其他人在哪里，决定是否去找他们
4. **目标导向**：会根据个人目标（如格斯的聚会计划）规划行为
5. **公告发布**：在小镇广场可以使用 "Post Notice" 行为在公告板发布消息

### 阶段 3：执行行为

LLM 生成决策后，系统执行以下操作：

1. **移动**：如果目标位置与当前位置不同，更新居民位置
2. **特殊行为处理**：
   - **发布公告**：如果在广场执行 "Post Notice"，将消息添加到公告板
3. **状态更新**：
   - 更新居民的状态文本（显示当前行为和对话）
   - 更新表情符号
   - 设置忙碌时间（`busy_until`），在此期间不会规划新行为
4. **记录日志**：记录行为到模拟日志中

### 阶段 4：特殊处理 - 睡眠与记忆优化

当居民决定睡觉时（行为持续时间超过120分钟），系统会触发记忆优化：

**记忆压缩机制**：
- **触发条件**：
  - 行为包含 "Sleep"、"Sleeping" 或 "睡觉"
  - 持续时间超过120分钟
  - 当天尚未优化过记忆
  
- **优化过程**：
  1. 收集当天的所有记忆
  2. 通过 LLM 生成记忆摘要
  3. 用摘要替换原始记忆
  4. 保留日期标记维护连续性

- **目的**：
  - 模拟人类夜间记忆巩固
  - 节省 token 消耗
  - 保持重要信息，丢弃琐碎细节

## 居民可执行的行为类型

根据代码分析和角色设定，居民可以执行以下类型的行为：

### 1. 移动行为
- **Go to [地点]**：前往指定地点
- 例如："Go to Saloon"（去酒馆）、"Go to Library"（去图书馆）

### 2. 社交行为
- **Chat with [人名]**：与特定居民交谈
- **对话系统**：自动触发，双方通过 LLM 生成真实对话内容
- 对话会被记录到双方记忆中

### 3. 日常行为
- **Work**：工作（根据职业）
- **Eat/Breakfast**：用餐
- **Read**：阅读（通常在图书馆）
- **Relax**：放松休息

### 4. 休息行为
- **Sleep**：睡觉（触发记忆优化）
- **Rest**：休息

### 5. 特殊行为
- **Post Notice**：在小镇广场公告板发布消息
- **研究、实验、探险**等职业相关行为

### 6. 空闲行为
- **Idle**：无特定活动，思考或观察周围

## 居民个性化行为示例

根据 `data/characters.json` 中的角色设定，不同居民展现不同的行为模式：

### 格斯（酒馆老板）
- **特殊任务**：计划三天后在广场举办联谊活动
- **典型行为**：
  - 在酒馆工作
  - 准备美食
  - 主动与其他居民交流，邀请参加活动
  - 在广场发布活动公告
  - 关心每位居民的需求

### 阿比盖尔（大学生、探险者）
- **个性驱动行为**：
  - 探索矿洞
  - 练习剑术
  - 吹奏长笛
  - 与塞巴斯蒂安等好友交流
  - 深夜可能不按时回家

### 德米特里厄斯（科学家）
- **理性主义行为**：
  - 进行野外科学研究
  - 记录生态数据
  - 在图书馆查阅资料
  - 与女儿玛鲁讨论科学话题
  - 较少社交互动

### 莱纳斯（野外生存者）
- **独特生活方式**：
  - 在山区帐篷生活
  - 觅食和采集
  - 偶尔访问小镇
  - 与大自然互动
  - 接受格斯等人的善意

## 时间流逝与昼夜循环

### 昼夜机制
- **白天**（06:00-22:00）：居民活跃期，进行各种活动
- **夜晚**（22:00-06:00）：大多数居民会回家睡觉
- 居民会根据时间自主决定何时回家

### 行为持续时间
- 最短持续时间：50分钟
- 典型持续时间：60-120分钟
- 睡眠时间：通常8小时以上（480分钟）

### 日程感知
- 居民具有强烈的日期意识
- 可以规划未来特定日期的活动
- 通过记忆系统追踪重要事件

## 记忆系统

### 记忆类型
1. **初始记忆**：角色的特殊任务和背景
2. **对话记忆**：与其他居民的交流内容
3. **行为记忆**：重要的行动和决定
4. **优化记忆**：每日摘要（夜间生成）

### 记忆格式
```
[时间戳] 事件描述
```

例如：
```
[2025-01-01 10:30] I chatted with Emily. I said: '...' They replied: '...'
```

### 记忆影响
- 居民的所有决策都基于记忆
- 记忆帮助维持人格一致性
- 记忆驱动长期目标的实现

## 交互冷却机制

为避免居民反复触发相同交互：

- **冷却时间**：两人对话后，会设置冷却期（默认配置）
- **冷却作用**：在冷却期内，同一对居民不会再次自动对话
- **交互概率**：即使没有冷却，也有随机概率控制对话触发频率

## 模拟结束条件

模拟会在以下情况结束：
1. 达到设定的模拟天数（默认3天）
2. 所有居民都处于睡眠状态
3. 用户手动停止模拟

## 日志记录

系统记录以下事件：
- **plan**：居民的行为规划
- **dialogue**：居民间的对话
- **notice**：公告板发布

日志可用于回放模拟过程。

## 技术实现要点

### 异步处理
- LLM 调用在独立线程中进行
- 避免阻塞主模拟循环
- 多个居民可以同时进行决策

### 状态同步
- 使用 `is_thinking` 标志防止重复规划
- 使用 `busy_until` 控制行为持续时间
- 保证居民状态的一致性

### LLM 集成
- 支持 OpenAI API 风格接口
- 可为每个居民配置独立的 LLM 客户端
- 结构化 JSON 输出确保可靠解析

## 总结

AI 小镇中每个居民的行为循环是一个持续的决策-执行过程：

1. **感知**：获取当前时间、位置、环境和记忆信息
2. **决策**：通过 LLM 根据个性和情境生成行为计划
3. **执行**：移动、交流、发布公告等具体行为
4. **记忆**：将经历添加到记忆中，影响未来决策
5. **休息**：夜间睡眠时优化记忆，准备新的一天

这个循环使每个居民成为具有独立人格、记忆和目标的"数字生命"，共同构成了一个生动的虚拟小镇生态系统。
